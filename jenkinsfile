pipeline {
    agent {
    label 'dkas'
    }
    stages{
        stage('Pull code'){
            steps{
            git 'https://ijazbro@bitbucket.org/ijazbro/addressbook-edureka.git'
        }
        }
        stage('test'){
            steps{
                sh "mvn test"
            }
        }
        stage('cobeture report'){
            steps{
                sh "mvn cobertura:cobertura -Dcobertura.report.format=xml"
            }
        }
        stage('pmd analysis'){
            steps{
                sh "mvn pmd:pmd"
            }
        }
        stage('check style'){
            steps{
                sh "mvn checkstyle:checkstyle"
                recordIssues(tools: [checkStyle(reportEncoding: 'UTF-8')])
            }
        }
        stage('build'){
            steps{
                sh "mvn package"
            }
        }
        stage('docker build') {
            steps {
                
                sh "chmod a+x docker.sh"
                sh "sh docker.sh"
                sh 'docker build . -t ijazu/addressbook-$BUILD_ID'
            
            sh "docker run -itd --name book -p 8082:8080 ijazu/addressbook-$BUILD_ID"
        }
           
    }
    
    
    stage('docker push') {
        steps {
             withDockerRegistry(credentialsId: 'dockerhub', url: 'https://index.docker.io/v1/') {
              sh 'docker push ijazu/addressbook-$BUILD_ID:latest'
              }
        sh 'docker system prune -a -f'
    
    }
       
       }  
    }
    }